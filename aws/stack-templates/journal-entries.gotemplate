{{{define "journal-entries"}}}
"JournalEntriesListenerRule": {
  "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
  "DependsOn": [
    "ListenerTls"
  ],
  "Properties": {
    "Actions": [
      {
        "TargetGroupArn": {
          "Ref": "JournalEntriesTargetGroup"
        },
        "Type": "forward"
      }
    ],
    "Conditions": [
      {
        "Field": "path-pattern",
        "Values": [
          "/orgs/*/books/*/journal-entries*",
          "/journal-entries-health-check"
        ]
      }
    ],
    "ListenerArn": {
      "Ref": "ListenerTls"
    },
    "Priority": 50
  }
},
"JournalEntriesTargetGroup": {
  "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
  "Properties": {
    "HealthCheckIntervalSeconds": 300,
    "HealthCheckPath": "/journal-entries-health-check",
    "HealthCheckProtocol": "HTTPS",
    "Matcher": {
      "HttpCode": "200"
    },
    "Name": {
      "Fn::Sub": "${AWS::StackName}-journal-entries"
    },
    "Port": 1,
    "Protocol": "HTTPS",
    "VpcId": {
      "Ref": "Vpc"
    }
  }
},
"JournalEntriesTask": {
  "DependsOn": [
    "TaskPolicy"
  ],
  "Type": "AWS::ECS::TaskDefinition",
  "Properties": {
    "ContainerDefinitions": [
      {
        "DockerSecurityOptions": [
          "no-new-privileges"
        ],
        "Environment": [
          {{{ template "environment" }}}
        ],
        "Essential": true,
        "Image": {
          "Fn::Sub": "${SlDockerRegistry}/${AWS::StackName}-journal-entries:${SlGitSha}"
        },
        "LogConfiguration": {
          {{{ template "task-log-configuration" }}}
        },
        "MemoryReservation": 64,
        "Name": "journal-entries",
        "PortMappings": [
          {
            "ContainerPort": 443
          }
        ],
        "ReadonlyRootFilesystem": true
      }
    ],
    "Family": {
      "Fn::Sub": "${AWS::StackName}-journal-entries"
    },
    "TaskRoleArn": {
      "Fn::GetAtt": [
        "TaskRole",
        "Arn"
      ]
    }
  }
},
"JournalEntriesService": {
  "DependsOn": [
    "JournalEntriesListenerRule",
    "JournalEntriesTargetGroup"
  ],
  "Type": "AWS::ECS::Service",
  "Properties": {
    "Cluster": {
      "Ref": "Cluster"
    },
    "TaskDefinition": {
      "Ref": "JournalEntriesTask"
    },
    "DeploymentConfiguration": {
      "MaximumPercent": "200",
      "MinimumHealthyPercent": "50"
    },
    "DesiredCount": 4,
    "LoadBalancers": [
      {
        "ContainerName": "journal-entries",
        "ContainerPort": "443",
        "TargetGroupArn": {
          "Ref": "JournalEntriesTargetGroup"
        }
      }
    ],
    "PlacementStrategies": [
      {
        "Type": "spread",
        "Field": "attribute:ecs.availability-zone"
      }
    ],
    "Role": {
      "Ref": "ServiceRole"
    }
  }
}
{{{end}}}
